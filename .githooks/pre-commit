#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${TFSTATE_AMEND_IN_PROGRESS:-}" ]]; then
  exit 0
fi

source "$(git rev-parse --show-toplevel)/.githooks/tfstate-common.sh"
tfstate_setup

if [[ ! -f "$TFSTATE" ]]; then
  echo "No terraform.tfstate file found; skipping pre-commit hook."
  exit 0
fi

pubkey="$(tfstate_pubkey pre-commit)"

if [[ -f "$CHECKSUM" ]]; then
  current_sum="$(tfstate_checksum)"
  stored_sum="$(tfstate_stored_checksum)"
  if [[ -n "$stored_sum" && "$current_sum" == "$stored_sum" ]]; then
    echo "tfstate unchanged; skipping re-encrypt."
    exit 0
  else
    echo "tfstate has changed; updating encrypted file and checksum."
  fi
fi

tfstate_encrypt_and_stage "$pubkey"
